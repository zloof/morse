node {
    stage ('Checkout'){
        git branch: 'build-first-jenkins-build', url: 'https://github.com/zloof/morse.git'
    }
    stage ('pull'){
        // login to AWS-ECR and pull the docker image
        docker.withRegistry('https://138858731413.dkr.ecr.us-east-1.amazonaws.com', 'ecr:us-east-1:demo-ecr-credentials') {
            docker.image('zloof/morse:latest').pull()
        }
    }
    stage ('test'){
        // RUN the server in the background
        def status = null
        try {
            status = sh(returnStatus: true, script: "docker-compose -f docker-compose-test.yml up --abort-on-container-exit")
            echo "status code: ${status}"
        }
        catch(Exception e){

        }
        finally{
            sh "docker-compose -f docker-compose-test.yml down"
            if (status != 0) {
                error "Tests failed, please read logs..."
            }
        }
    }
}
