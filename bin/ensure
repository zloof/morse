#!/bin/bash

set -x
set -e


# bin/asdf-install

docker pull "$ECR_IMAGE_NAME:$IMAGE_TAG_DEV_LATEST"
docker tag  "$ECR_IMAGE_NAME:$IMAGE_TAG_DEV_LATEST" "${IMAGE_NAME}:dev"

# namespace="${PROJECT}"
# deployment_name="${PROJECT}"
# # step 1 - generate-eks-kubeconfig
# export KUBECONFIG="${PWD}/kubeconfig-audience-us1"
# bin/generate-eks-kubeconfig audience-us1 applicaster-audience > "${KUBECONFIG}"
# # step 2 - decrypt

kubesec decrypt --debug -x --template='JWT_PRIVATE="{{ .data.JWT_PRIVATE }}"'  chart/templates/_secret-app-env.enc.yaml > .env
kubesec decrypt --debug -x --template='JWT_PUBLIC="{{ .data.JWT_PUBLIC }}"'  chart/templates/_secret-app-env.enc.yaml >> .env

# function cleanup {
#   rm $KUBECONFIG
# }
# trap cleanup EXIT

docker-compose -f docker-compose-test.yml run --rm app sh -c "PRODUCTION_DOMAIN=https://di.applicaster.com/ npm run test:e2e"

