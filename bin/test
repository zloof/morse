#!/bin/bash

set -x
set -e

bin/asdf-install

docker pull "$ECR_IMAGE_NAME:$IMAGE_TAG_DEV_LATEST"
docker tag  "$ECR_IMAGE_NAME:$IMAGE_TAG_DEV_LATEST" "${IMAGE_NAME}:dev"

kubesec decrypt --debug -x --template='JWT_PRIVATE="{{ .data.JWT_PRIVATE }}"'  chart/templates/_secret-app-env.enc.yaml > .env
kubesec decrypt --debug -x --template='JWT_PUBLIC="{{ .data.JWT_PUBLIC }}"'  chart/templates/_secret-app-env.enc.yaml >> .env

docker-compose -f docker-compose-test.yml build
docker-compose -f docker-compose-test.yml up -d
sleep 5
docker-compose -f docker-compose-test.yml run app sh -c "PRODUCTION_DOMAIN=http://app:3000/ npm run test:e2e"
docker-compose -f docker-compose-test.yml down
